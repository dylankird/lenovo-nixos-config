# Connect to Wifi

sudo su

gdisk /dev/nvme0n1
    - o make new partition map
    - n make new partition
    - +2G for 2GiB
    - ef00 as the filesystem type (or 1 for alias)
    - n for new partition
    - hit enter a bunch of times* (do 44 for alias of partition type) 8e00
    - w for write
    #(basically I made a 2GB EFI partition and filled the remaining with a regular linux filesystem partition using gdisk)
    
cryptsetup -y -v --label=NIXLUKS luksFormat --type luks2 /dev/nvme0n1p2
cryptsetup open /dev/nvme0n1p2 cryptroot

pvcreate /dev/mapper/cryptroot

vgcreate vg0 /dev/mapper/cryptroot

lvcreate -L 500G vg0 -n root
lvcreate -l 100%FREE vg0 -n home

mkfs.fat -F32 -n NIXBOOT /dev/nvme0n1p1
mkfs.ext4 -L NIXROOT /dev/mapper/vg0-root
mkfs.btrfs -L NIXHOME /dev/mapper/vg0-home

mount /dev/mapper/vg0-home /mnt
btrfs subvolume create /mnt/@home
umount /mnt

# New:
mount /dev/disk/by-label/NIXROOT /mnt
mkdir /mnt/boot
mount -o umask=0077 /dev/disk/by-label/NIXBOOT /mnt/boot

mkdir /mnt/home
mount -o subvol=@home,compress=zstd,noatime /dev/disk/by-label/NIXHOME /mnt/home

git clone git@github.com:dylankird/lenovo-nixos-config.git /mnt/etc/nixos

nixos-generate-config --root /mnt

vim /mnt/etc/nixos/hardware-configuration.nix

# Changes:
boot.initrd.kernelModules = [ "dm-snapshot" "cryptd" ]; # add cryptd
#Add:
boot.initrd.luks.devices."cryptroot".device = "/dev/disk/by-label/NIXLUKS";
#Switch to labels instead of UUIDs to mount LVs
#Add:
hardware.enableAllFirmware = true; # Helps with compatibility

# At this point you move lenovo-flake.nix to flake.nix and lenovo-configuration.nix to configuration.nix
# You should look through configuration.nix to see if there's anything that was autogenerated that should be in your config

cd /mnt

sudo nixos-install --flake /mnt/etc/nixos#lenovo-nixos

# If the installer complains, use this flag: --option experimental-features "nix-command flakes"

# Reboot
